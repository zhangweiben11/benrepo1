<?xml version="1.1" encoding="UTF-8"?>
<!-- salt:cde82315-e936-41f1-90c6-32daeeda6afd -->
<metadata name="pkgPI_FacetSearch" path="/shared/Delta_DV/Physical/Formatting/PackagedQueries/Billing/pkgPI_FacetSearch" type="PROCEDURE" subtype="EXTERNAL_SQL_PROCEDURE" changeToken="0">
  <annotation><![CDATA[InvoiceSearch API for EbillPay:This query is to extract invoice details from invoice table 
in EbillPay database.It connects to note and lineitem tables in the same DB for 
notes and lineitem flags]]></annotation>
  <parameters>
    <parameter name="BillToGroupName" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="BillToGroupNumber" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="200"/>
    </parameter>
    <parameter name="BillToId" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="BillerId" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="Brand" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="100"/>
    </parameter>
    <parameter name="InvoiceStartDate" direction="IN" nullable="true">
      <datatype name="DATE" type="DATE"/>
    </parameter>
    <parameter name="InvoiceEndDate" direction="IN" nullable="true">
      <datatype name="DATE" type="DATE"/>
    </parameter>
    <parameter name="invoiceNumber" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="50"/>
    </parameter>
    <parameter name="InvoiceStatus" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="InvoiceType" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="LegalEntity" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="4000"/>
    </parameter>
    <parameter name="ReconNoteExists" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="1"/>
    </parameter>
    <parameter name="ReconLineItemExists" direction="IN" nullable="true">
      <datatype name="VARCHAR" type="STRING" maxLength="1"/>
    </parameter>
    <parameter name="result" direction="OUT" nullable="true">
      <datatype type="TABLE" refId="256">
        <element name="billToGroupName">
          <datatype name="VARCHAR" extendedName="nvarchar(4000)" subType="DATASOURCE_TYPE" type="STRING" maxLength="4000"/>
        </element>
        <element name="legalEntity">
          <datatype name="VARCHAR" extendedName="nvarchar(4000)" subType="DATASOURCE_TYPE" type="STRING" maxLength="4000"/>
        </element>
        <element name="billToId">
          <datatype name="VARCHAR" extendedName="nvarchar(4000)" subType="DATASOURCE_TYPE" type="STRING" maxLength="4000"/>
        </element>
        <element name="billerId">
          <datatype name="VARCHAR" extendedName="nvarchar(4000)" subType="DATASOURCE_TYPE" type="STRING" maxLength="4000"/>
        </element>
        <element name="billToGroupNumber">
          <datatype name="VARCHAR" extendedName="nvarchar(4000)" subType="DATASOURCE_TYPE" type="STRING" maxLength="4000"/>
        </element>
        <element name="invoiceNumber">
          <datatype name="VARCHAR" extendedName="varchar(100)" subType="DATASOURCE_TYPE" type="STRING" maxLength="100"/>
        </element>
        <element name="reconnoteexists">
          <datatype name="VARCHAR" extendedName="varchar(1)" subType="DATASOURCE_TYPE" type="STRING" maxLength="1"/>
        </element>
        <element name="reconlineitemexists">
          <datatype name="VARCHAR" extendedName="varchar(1)" subType="DATASOURCE_TYPE" type="STRING" maxLength="1"/>
        </element>
      </datatype>
    </parameter>
  </parameters>
  <security>
    <owner user="nobody" domain="composite"/>
  </security>
  <dependency target="/shared/Delta_DV/Physical/Metadata/DataSources/Ebillpay" type="DATA_SOURCE">
    <datatype name="Tree" type="TREE" refId="257"></datatype>
  </dependency>
  <attribute name="SQL" type="STRING">&lt;version 2&gt; 
select * from
(SELECT 
    invoice.v_group_name billToGroupName,  
    invoice.v_invoice_legal_entity legalEntity, 
    invoice.v_bill_to_id billToId, 
    invoice.v_biller_id billerId,
invoice.v_group_number billToGroupNumber,
invoice.invoice_number invoiceNumber,
case when note.note is null then &apos;N&apos; else &apos;Y&apos; end reconnoteexists,
case when lineitem.lineitemId is null then &apos;N&apos; else &apos;Y&apos; end reconlineitemexists
from [Group-Invoice].[dbo].[invoice] invoice
left outer join [Invoice-Reconciliation-Service].[dbo].[note] note
ON  invoice.invoice_number =note.invoice_number
left outer join [Invoice-Reconciliation-Service].[dbo].[lineitem] lineitem
ON  invoice.invoice_number =lineitem.invoice_number
AND ((CHARINDEX(&apos;%&apos;,&apos;{0}&apos;) &gt; 0  
AND invoice.v_group_name like COALESCE(NULLIF(&apos;{0}&apos;,&apos;NULL&apos;),invoice.v_group_name))
OR invoice.v_group_name IN (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{0}&apos;,&apos;NULL&apos;),invoice.v_group_name)), &apos;,&apos;)))
AND invoice.v_group_number like COALESCE(NULLIF(&apos;{1}&apos;,&apos;NULL&apos;),invoice.v_group_number)
AND invoice.v_bill_to_id in (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{2}&apos;,&apos;NULL&apos;),invoice.v_bill_to_id)), &apos;,&apos;))
AND invoice.v_biller_id in (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{3}&apos;,&apos;NULL&apos;),invoice.v_biller_id)), &apos;,&apos;))
AND invoice.v_brand = COALESCE(NULLIF(&apos;{4}&apos;,&apos;NULL&apos;),invoice.v_brand)
AND invoice.v_invoice_date &gt;= COALESCE({5},invoice.v_invoice_date) 
AND invoice.v_invoice_date &lt;= COALESCE({6},invoice.v_invoice_date) 
AND invoice.invoice_number like COALESCE(NULLIF(&apos;{7}&apos;,&apos;NULL&apos;),invoice.invoice_number)
AND invoice.invoice_status in (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{8}&apos;,&apos;NULL&apos;),invoice.invoice_status)), &apos;,&apos;))
AND invoice.v_invoice_type in (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{9}&apos;,&apos;NULL&apos;),invoice.v_invoice_type)), &apos;,&apos;))
AND invoice.v_invoice_legal_entity in (SELECT value FROM STRING_SPLIT(COALESCE(NULL,COALESCE(NULLIF(&apos;{10}&apos;,&apos;NULL&apos;),invoice.v_invoice_legal_entity)), &apos;,&apos;))
AND invoice_Status&lt;&gt;&apos;DISCARD&apos;)a
where a.reconnoteexists like COALESCE(NULLIF(&apos;{11}&apos;,&apos;NULL&apos;),a.reconnoteexists)
AND a.reconLineItemexists like COALESCE(NULLIF(&apos;{12}&apos;,&apos;NULL&apos;),a.reconLineItemexists)
</attribute>
  <attribute name="creationDate" type="LONG">1596519415150</attribute>
  <attribute name="creatorUserDomain" type="STRING">dev</attribute>
  <attribute name="creatorUserId" type="INTEGER">2850169</attribute>
  <attribute name="creatorUserName" type="STRING">dca32905</attribute>
  <attribute name="isSingleSelect" type="STRING">false</attribute>
  <attribute name="lastModifiedDate" type="LONG">1612826929001</attribute>
  <attribute name="lastModifiedUserDomain" type="STRING">dev</attribute>
  <attribute name="lastModifiedUserId" type="INTEGER">2850169</attribute>
  <attribute name="lastModifiedUserName" type="STRING">dca89313</attribute>
  <attribute name="passThroughSource" type="STRING">/shared/Delta_DV/Physical/Metadata/DataSources/Ebillpay</attribute>
  <attribute name="resourceModifiedDateOnSourceCISSite" type="LONG">1596519415150</attribute>
</metadata>